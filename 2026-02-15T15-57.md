> У меня есть SQLite база данных
>
> В ней есть таблица "foo", с колонкой "date_", в которой хранится дата как текст в ISO-формате
>
> Мне нужен SQL-запрос, который найдёт самую позднюю дату в этой колонке и выведет мне строку в которой будет записан предыдущий месяц в формате "YYYY-MM"

```sql
SELECT strftime('%Y-%m', date((SELECT MAX(date_) FROM foo), '-1 month')) AS previous_month;
```

## Объяснение

Этот запрос сначала находит максимальную дату в колонке `date_` с помощью подзапроса 
```sql
SELECT MAX(date_) FROM foo
```

Затем функция `date(..., '-1 month')` вычисляет дату на один месяц раньше, правильно обрабатывая переходы между месяцами (например, из января в декабрь предыдущего года).[^1_2]

Наконец, `strftime('%Y-%m', ...)` форматирует результат в нужный формат "YYYY-MM".[^1_1]

> Оформи полученный как cte и используй его для поиска всех записей в таблице foo, у которых колонка "date_" относится к найденному месяцу

```sql
WITH prev_month AS (
SELECT strftime('%Y-%m', date((SELECT MAX(date_) FROM foo), '-1 month')) AS month_str
)
SELECT f.*
FROM foo f, prev_month
WHERE strftime('%Y-%m', f.date_) = prev_month.month_str;[^2_1][^2_2][^2_3][^2_4]
```

## Объяснение

CTE `prev_month` вычисляет строку предыдущего месяца в формате "YYYY-MM" на основе максимальной даты из таблицы `foo`.[^2_5][^2_3][^2_4]

В основном запросе все записи из `foo` фильтруются по условию, где `strftime('%Y-%m', date_)` извлекает "YYYY-MM" из каждой даты и сравнивает с значением из CTE.[^2_2][^2_1]

Это гарантирует выбор только записей, относящихся именно к тому месяцу (независимо от дня).

### Sources
[^1_1]: https://database.guide/how-to-extract-the-day-month-and-year-from-a-date-in-sqlite/

[^1_2]: https://database.guide/subtract-months-from-a-date-in-sqlite/

[^1_3]: https://docs.sqlitecloud.io/docs/sqlite/lang_datefunc

[^1_4]: https://www.sqlservercentral.com/forums/topic/max-date-from-previous-month

[^1_5]: https://www.w3resource.com/sqlite/sqlite-strftime.php

[^1_6]: https://www.sqlitetutorial.net/sqlite-date/

[^1_7]: https://stackoverflow.com/questions/70711725/how-to-get-previous-month-number-in-sqlite

[^1_8]: https://www.reddit.com/r/SQL/comments/9pmbju/sqlite_how_to_convert_date_column_from_month_year/

[^1_9]: https://www.w3resource.com/sqlite/snippets/sqlite-date-functions-explained.php

[^1_10]: https://www.reddit.com/r/sqlite/comments/4c12gg/failing_to_get_maxdate_query_to_work_with_data_in/

[^1_11]: https://stackoverflow.com/questions/63691498/how-to-use-strftime-function-in-sqlite-for-extracting-year-where-datetime-is-i

[^1_12]: https://database.guide/add-months-to-a-date-in-sqlite/

[^1_13]: https://www.sqlitetutorial.net/sqlite-date-functions/sqlite-strftime-function/

[^1_14]: https://stackoverflow.com/questions/5485813/is-the-1-month-in-sqlite-datetime-function-broken

[^1_15]: https://stackoverflow.com/questions/650480/get-month-from-datetime-in-sqlite

[^1_16]: https://sqlite.org/forum/info/c6fc65d76e5d8d40c0aab7782ca52f408d155ef50df9fcc83544f55989b19fd6?t=h

[^1_17]: https://learnsql.com/cookbook/how-to-add-a-month-to-a-date-in-sqlite/

[^1_18]: https://www.codegenes.net/blog/get-month-from-datetime-in-sqlite/

[^2_1]: https://stackoverflow.com/questions/75278463/filtering-sqlite-records-using-strftime

[^2_2]: https://stackoverflow.com/questions/33688263/sqlite-filter-records-by-month-year

[^2_3]: https://database.guide/how-to-extract-the-day-month-and-year-from-a-date-in-sqlite/

[^2_4]: https://database.guide/subtract-months-from-a-date-in-sqlite/

[^2_5]: https://www.sqlitetutorial.net/sqlite-cte/

[^2_6]: https://www.w3resource.com/sqlite/snippets/sqlite-date-functions-explained.php

[^2_7]: https://support.atlassian.com/analytics/docs/sqlite-date-and-time-functions/

[^2_8]: https://www.geeksforgeeks.org/sqlite/sqlite-date-and-time/

[^2_9]: https://www.reddit.com/r/SQL/comments/xrj0oh/sqlite_where_filter_by_date_formatted_as_follows/

[^2_10]: https://sqlite.org/lang_datefunc.html

[^2_11]: https://docs.sqlitecloud.io/docs/sqlite/lang_datefunc

[^2_12]: https://forum.lazarus.freepascal.org/index.php?topic=59608.0
